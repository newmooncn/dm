<?xml version="1.0" encoding="utf-8"?>
<!-- vim:fdn=3:
-->
<openerp>
    <data>
        <template id="dm_rubylong.layout_base" name="Rubylong layout base">&lt;!DOCTYPE html&gt;
            <html style="height: 100%">
                <head>
                    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
                    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
                    <title>Odoo</title>                    
    				<script src="/dm_rubylong/static/CreateControl.js" type="text/javascript"></script>
    				<script src="/dm_rubylong/static/GRInstall.js" type="text/javascript"></script> 
				    <script type="text/javascript">
				        Install_InsertReport();
				    </script>   
					<script type="text/javascript" id="rubylong_js">   
						function OnSaveReport()
						{
							//设置 DefaultAction 属性为 false，不执行控件本身的默认保存行为
							ReportDesigner.DefaultAction = false;							
						    ReportDesigner.Post();  //将设计器中的设计数据提交到报表对象						    
						    var ReportName = "1a_new.grf"; //这里可以是一个参数化的变量
						    var LoadURL = "/report/html/38?Report=" + ReportName + '?dt=' + cur_time;
						    alert(LoadURL);
						    var success = ReportDesigner.Report.SaveToURL( encodeURI(LoadURL) );
						    if ( success )
						        alert("保存报表成功!");
						    else
						        alert("保存报表失败!");
						}		
						function getFileName(report_obj){
							var title = "<t t-esc='report_title'/>";
							<t t-if="len(doc_ids)==1">
								title += "_<t t-esc='docs[0].name'/>";
							</t>
							return title
						}			
						//ref Grid++Report 6\WebSamples\jsp\03.Export
						function OnExportBegin(OptionObject) 
						{
						    if (OptionObject.ExportType == 5) //gretPDF	
						    {
						        var E2PDFOption = OptionObject.AsE2PDFOption;
						        E2PDFOption.AnsiTextMode = false;
						        //下面代码不能控制是否压缩选项
						        E2PDFOption.Compressed = false;
						    }
						}		
						//does not work
						function OnExportEnd(OptionObject)
						{
						    window.close();
						}										
						function window_onload() {
				        	var export_direct = <t t-esc="export_direct"/>;
				        	var rpt_obj;
				        	if (export_direct != 1) {
				        		 rpt_obj = ReportViewer.Report;
				        		 rpt_obj.Title = getFileName(rpt_obj);
				        	} else {
				        		rpt_obj = Report;
					        }					        
					        rpt_obj.OnExportBegin = OnExportBegin;
					        rpt_obj.OnExportEnd = OnExportEnd;					        						    
						}
					</script>
					<script type="text/javascript" id="rubylong_run">
					    var cur_time = new Date().getTime();
				        //var url_report_read = 'GET::<t t-esc="url_report_read"/>?dt=' + cur_time;
				        var url_report_read = 'GET::<t t-esc="rubylong_file_path"/>?dt=' + cur_time;
				        <t t-raw="0"/>
					    //var to_desigin = <t t-esc="to_design"/>;\
					    var to_desigin = false;
				        if (!to_desigin) {		
				        	var export_direct = <t t-esc="export_direct"/>
				        	if (export_direct != 1) {
				        		CreatePrintViewerEx("100%", "100%", url_report_read , url_data_load, true, "&lt;param name=BorderStyle value=1&gt;");
				        	} else {
					        	CreateReport('Report');
					        	Report.OnExportBegin = OnExportBegin;
					        	file_name = getFileName(Report)
					        	Report.LoadFromURL(url_report_read);
					        	Report.LoadDataFromURL(url_data_load);
					        	Report.ExportDirect(<t t-esc="export_direct_type"/>,file_name,true, true);
					        }
				        } else {
				        	/*
				        	TODO Since rubylong can not get the seesion's cookie under firefox and chrome, 
				        	so can not find designer saving available way now
				        	wait solving method
				        	*/
				        	//goto design page
				        	//window.open('report/html/38', '_blank', 'scrollbars=1,height=900,width=1280');
				        	var url_report_write = '<t t-esc="url_report_write"/>'
				            CreateDesigner(url_report_read , '', url_data_load, "&lt;param name='BorderStyle' value='1'&gt;&lt;param name='OnSaveReport' value='OnSaveReport'&gt;");
				        }			        
					</script>
					          
				    <style type="text/css">
				        html, body {
				            margin: 0;
				            height: 100%;
				        }
				    </style>
				                    
                </head>
                <body onload="window_onload()">
				    <script type="text/javascript">
					    var Installed = Install_Detect();
				    </script>  	
                </body>
            </html>
        </template>
        
        <template id="dm_rubylong.layout" name="Rubylong layout">
        	<!-- use the standard metod  docs[0].rubylong_xml_file to replace the <t t-raw="0"/> in dm_rubylong.layout.base-->
		    <t t-call="dm_rubylong.layout_base">
		    	var url_data_load = 'GET::<t t-raw='docs[0].rubylong_xml_file'/>?dt=' + cur_time;
		    </t>
        </template>

    </data>
</openerp>
